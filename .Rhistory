x = "Semana (fecha de inicio)",
y = "Cantidad de productos"
) +
theme_minimal()
# Productos vendidos por semana
# Mutar la columna para que 'semana' sea el número de la semana del año
datos <- datos %>%
mutate(semana = floor_date(fecha, unit = "week", week_start = 1),
semana_numero = format(semana, "%U"))  # Esto extrae el número de semana del año
# Crear el gráfico
ventas_por_semana <- datos %>%
count(semana)
ggplot(ventas_por_semana, aes(x = semana, y = n)) +
geom_bar(stat = "identity", fill = "skyblue", color = "black") +
labs(
title = "Productos vendidos por semana del año",
x = "Semana (fecha de inicio)",
y = "Cantidad de productos"
) +
theme_minimal() +
scale_x_date(labels = scales::date_format("%U"), breaks = "1 week") # Muestra el número de la semana
library(recommenderlab)
library(dplyr)
library(tidyr)
library(rsparse)
library(ggplot2)
# cargamos los datos
tickets <- readRDS("Datos\\Transformados\\tickets_Reducidos.rds")
clusteres <- readRDS("Datos\\Transformados\\df_con_clusteres.rds")
productos <- readRDS("Datos\\Originales\\maestroestr.RDS")
objetivos <- readRDS("Datos\\Originales\\objetivos.RDS")
##################################### OBJETIVO 1 ###############################
objetivo1 <- as.data.frame(objetivos[[1]])
objetivo2 <- as.data.frame(objetivos[[2]])
# ------------------------ como en este caso lo que queremos es recomendar a los 10
# usuarios mas relevantes un producto en especifico, el proceso a seguir es este:
# Entrenar el modelo
# cargar la matriz
matriz_general <- readRDS("Datos\\Resultados\\Matriz.rds")
rownames(matriz_general) <- matriz_general$id_cliente_enc
matriz_general <- matriz_general[,-1]
matriz_rec <- as.matrix(matriz_general)
matriz_rec <- as(matriz_rec,"realRatingMatrix")
# --------------------- ESTADÍSTICOS DE LA MATRIZ
matriz <- as(matriz_general,"matrix")
recuentoF <- rowCounts(matriz_rec) # cuantas celditas de una fila son diferentes de NA (cuantas pelis ha valorado cada usuario)
recuentoC <- colCounts(matriz_rec) # cuantas celditas de una columna son diferentes de NA
max(matriz,na.rm=T) ; min(matriz, na.rm=T)
# MEDIAS
media_columnas <- colMeans(matriz_rec,na.rm=T)
media_filas <- rowMeans(matriz_rec,na.rm=T)
hist(media_filas)
hist(media_columnas)
# PARA SABER EL GOODRATING Y EL GIVEN
min(recommenderlab::rowCounts(matriz_rec,na.rm=T))
######################### RECOMENDADORES CON RECOMMENDERLAB ####################
set.seed(8)
# --------------------------- TRAIN Y TEST
eval_scheme <- evaluationScheme(matriz_rec, method = "split",
train = 0.8, given= 1,
goodRating = 2)
# -------------------------- ENTRENAR MODELOS :
algos <- list("random" = list(name = "RANDOM", param = NULL),
"UBCF_10nn" = list(name = "UBCF", param = list(nn = 10)), # vecinos mas cercanos
"UBCF_50nn" = list(name = "UBCF", param = list(nn = 50)),
"IBCF_Pearson" = list(name = "IBCF", param = list(method = "Pearson")),
"popular" = list(name = "POPULAR" , param = NULL),
"svdf_50" = list(name = "SVDF",param = list(k=50)),
"svdf_100" = list(name = "SVDF",param = list(k=100)),
"svdf_200" = list(name = "SVDF",param = list(k=200)))
# ----------- TOPNLIST
eval <- evaluate(eval_scheme, algos, type = "topNList", n = c(1,3,5,10,15,20))
library(recommenderlab)
library(dplyr)
library(tidyr)
library(rsparse)
library(ggplot2)
library(Matrix)
# cargamos los datos
tickets <- readRDS("Datos\\Transformados\\tickets_Reducidos.rds")
clusteres <- readRDS("Datos\\Transformados\\df_con_clusteres.rds")
productos <- readRDS("Datos\\Originales\\maestroestr.RDS")
objetivos <- readRDS("Datos\\Originales\\objetivos.RDS")
############################### OBJETIVO 1 #####################################
# Creamos el modelo WRMF -------------------------------------------------------
matriz_general <- readRDS("Datos\\Resultados\\Matriz_sinNA.rds")
storage.mode(matriz_general) <- "numeric"
# para el objetivo 1 y 3 cambiamos filas por columnas
matriz_alreves <- t(matriz_general)
# -- MODELO:
modelo_wrmf_alreves <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf_alreves$fit_transform(matriz_alreves, n_iter = 1000L, convergence_tol=0.000001)
matriz_obj1 <- matriz_alreves[rownames(matriz_alreves) %in% objetivos$objetivo1$obj, , drop=F]
matriz_obj1 <- as(matriz_obj1,"sparseMatrix")
preds_1 <- modelo_wrmf_alreves$predict(matriz_obj1, k = 10) # para que nos de 10 usuarios
lista_1 <- attr(preds_1,'ids')
################################## OBJETIVO 2 ##################################
# modelo para el objetivo 2 y 4:
modelo_wrmf <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
matriz_obj2 <- matriz_general[rownames(matriz_general) %in% objetivos$objetivo2$obj,]
matriz_obj2 <- as(matriz_obj2,"sparseMatrix")
preds_2 <- modelo_wrmf$predict(matriz_obj2, k = 1, not_recommend = matriz_obj2)
preds_2 <- modelo_wrmf$predict(matriz_obj2, k = 1, not_recommend = matriz_obj2)
modelo_wrmf <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf$fit_transform(matriz_general, n_iter = 1000L, convergence_tol=0.000001)
matriz_obj2 <- matriz_general[rownames(matriz_general) %in% objetivos$objetivo2$obj,]
matriz_obj2 <- as(matriz_obj2,"sparseMatrix")
preds_2 <- modelo_wrmf$predict(matriz_obj2, k = 1, not_recommend = matriz_obj2)
preds_2
lista_2 <- attr(preds_2,'ids')
################################# OBJETIVO 3 ###################################
# el modelo es el mismo que para el objetivo 1
matriz_obj3 <- matriz_general
matriz_obj3 <- as(matriz_obj3,"sparseMatrix")
# cogemos los items que no queremos que recomiente para el predict
matriz_no_recomendados <- matriz_general [,!colnames(matriz_general) %in% objetivos$objetivo3$obj]
items_no_recomendados <- colnames(matriz_no_recomendados)
preds_3 <- modelo_wrmf$predict(matriz_obj3, k = 1, items_exclude = items_no_recomendados)
preds_3
lista_3 <- attr(preds_3,'ids')
obj4<-objetivos[[4]]$obj
tickets_obj4<- tickets[tickets$id_cliente_enc %in% obj4,]
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_filtrados, ultimos_tickets, by = "num_ticket")
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
historial_tickets <- left_join(historial_tickets,productos,by="cod_est")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, descripcion) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "descripcion",
values_from = "N_compras",
values_fill = 0
)
df_matriz
View(df_matriz)
preds_4 <- modelo_wrmf$predict(matriz_obj4, k = 1, items_exclude = df_matriz)
preds_4 <- modelo_wrmf_alreves$predict(matriz_obj4, k = 1, items_exclude = df_matriz)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, items_exclude = df_matriz)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, descripcion) %>%
summarise(N_compras = n(), .groups = "drop")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0
)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, descripcion) %>%
summarise(N_compras = n(), .groups = "drop")
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
historial_tickets <- left_join(historial_tickets,productos,by="cod_est")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, descripcion) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "descripcion",
values_from = "N_compras",
values_fill = 0
)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
modelo_wrmf
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0
)
preds_4 <- modelo_wrmf_alreves$predict(df_matriz, k = 1, not_recommend = df_matriz)
df_matriz
modelo_wrmf_alreves
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
modelo_wrmf
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0,  names_prefix="id_"
)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
preds_4 <- modelo_wrmf_alreves$predict(df_matriz, k = 1, not_recommend = df_matriz)
obj4<-objetivos[[4]]$obj
tickets_obj4<- tickets[tickets$id_cliente_enc %in% obj4,]
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
historial_tickets <- left_join(historial_tickets,productos,by="cod_est")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
)
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
colnames(df_matriz) <- as.character(colnames(df_matriz))
colnames(df_matriz) <- as.character(colnames(df_matriz))
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
items_modelo <- modelo_wrmf$item_ids
# Asegurarse de que estén todas las columnas que espera el modelo
faltan_items <- setdiff(items_modelo, colnames(df_matriz))
if (length(faltan_items) > 0) {
df_matriz[, faltan_items] <- 0  # añadir columnas faltantes con 0
}
# Reordenar columnas exactamente igual
df_matriz <- df_matriz[, items_modelo]
preds_4 <- modelo_wrmf$predict(df_matriz, k = 1, not_recommend = df_matriz)
matriz_sparse <- as(as.matrix(df_matriz), "sparseMatrix")
# Llama a la predicción con el objeto correcto
preds_4 <- modelo_wrmf$predict(matriz_sparse, k = 1, not_recommend = matriz_sparse)
matriz_sparse
obj4<-objetivos[[4]]$obj
tickets_obj4<- tickets[tickets$id_cliente_enc %in% obj4,]
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
)
colnames(df_matriz) <- as.character(colnames(df_matriz))
items_modelo <- modelo_wrmf$item_ids
# Asegurarse de que estén todas las columnas que espera el modelo
faltan_items <- setdiff(items_modelo, colnames(df_matriz))
if (length(faltan_items) > 0) {
df_matriz[, faltan_items] <- 0  # añadir columnas faltantes con 0
}
# Reordenar columnas exactamente igual
df_matriz <- df_matriz[, items_modelo]
matriz_sparse <- as(as.matrix(df_matriz), "sparseMatrix")
matriz_sparse
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
)
colnames(df_matriz) <- as.character(colnames(df_matriz))
matriz_sparse <- as(as.matrix(df_matriz), "sparseMatrix")
id_clientes <- df_matriz$id_cliente_enc
df_numeric <- df_matriz[, !(names(df_matriz) %in% c("id_cliente_enc"))]
matriz_sparse <- as(as.matrix(df_numeric), "sparseMatrix")
# Llama a la predicción con el objeto correcto
preds_4 <- modelo_wrmf$predict(matriz_sparse, k = 1, not_recommend = matriz_sparse)
obj4<-objetivos[[4]]$obj
tickets_obj4<- tickets[tickets$id_cliente_enc %in% obj4,]
ultimos_tickets <- tickets_obj4 %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_obj4, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
)
colnames(df_matriz) <- as.character(colnames(df_matriz))
id_clientes <- df_matriz$id_cliente_enc
df_numeric <- df_matriz[, !(names(df_matriz) %in% c("id_cliente_enc"))]
matriz_sparse <- as(as.matrix(df_numeric), "sparseMatrix")
# Llama a la predicción con el objeto correcto
preds_4 <- modelo_wrmf$predict(matriz_sparse, k = 1, not_recommend = matriz_sparse)
matriz_sparse
matriz_sparse<- ifelse(matriz_sparse==NA, 0, matriz_sparse)
# Llama a la predicción con el objeto correcto
preds_4 <- modelo_wrmf$predict(matriz_sparse, k = 1, not_recommend = matriz_sparse)
matriz_sparse
matriz_sparse <- as(as.matrix(df_numeric), "sparseMatrix")
################################# OBJETIVO 4 ###################################
obj4<-objetivos[[4]]$obj
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
tickets_filtrados_agrupados<- tickets_filtrados%>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n())
tickets_filtrados <- tickets_filtrados %>%
mutate(fecha = ymd(dia))
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(fecha == max(fecha)) %>%
ungroup()
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
tickets_filtrados_agrupados<- tickets_filtrados%>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n())
ultimos_tickets <- tickets_filtrados_agrupados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
################################# OBJETIVO 4 ###################################
obj4<-objetivos[[4]]$obj
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
tickets_filtrados
tickets_filtrados_agrupados<- tickets_filtrados%>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n())
tickets_filtrados_agrupados
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_filtrados, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0,
names_prefix = "id_"
)
matriz_sparse_o4 <- as(as.matrix(df_matriz[,-1]), "dgCMatrix")
rownames(matriz_sparse_o4) <- df_matriz$id_cliente_enc
preds_4 <- modelo_wrmf$predict(matriz_sparse_o4, k = 1)
modelo_wrmf_o4 <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf_o4$fit_transform(matriz_sparse_o4, n_iter = 1000L, convergence_tol = 1e-6)
preds_o4 <- modelo_wrmf_o4$predict(matriz_sparse_o4, k = 1)
clientes <- rownames(matriz_sparse_o4)
productos_predichos <- attr(preds_o4, "ids")
recomendaciones_o4 <- data.frame(
id_cliente_enc = clientes,
producto_olvidado = productos_predichos
)
recomendaciones_o4 <- recomendaciones_o4 %>%
mutate(cod_est = str_remove(producto_olvidado, "id_")) %>%
left_join(maestro %>% select(cod_est, descripcion), by = "cod_est") %>%
select(id_cliente_enc, cod_est, descripcion)
library(stringr)
recomendaciones_o4 <- recomendaciones_o4 %>%
mutate(cod_est = str_remove(producto_olvidado, "id_")) %>%
left_join(maestro %>% select(cod_est, descripcion), by = "cod_est") %>%
select(id_cliente_enc, cod_est, descripcion)
recomendaciones_o4 <- recomendaciones_o4 %>%
mutate(cod_est = str_remove(producto_olvidado, "id_")) %>%
left_join(productos %>% select(cod_est, descripcion), by = "cod_est") %>%
select(id_cliente_enc, cod_est, descripcion)
View(recomendaciones_o4)
recomendaciones_o4 <- data.frame(
id_cliente_enc = clientes,
producto_olvidado = productos_predichos
)
library(stringr)
recomendaciones_o4 <- recomendaciones_o4 %>%
mutate(cod_est = str_remove(producto_olvidado, "id_")) %>%
left_join(productos %>% select(cod_est, descripcion), by = "cod_est") %>%
select(id_cliente_enc, cod_est, descripcion)
lista_1
recomendaciones_o4
lista_3
recomendaciones_o3 <- data.frame(
id_cliente_enc = clientes_predichos,
producto = productos
)
recomendaciones_o3 <- data.frame(
id_cliente_enc = lista_3,
producto = productos
)
recomendaciones_o3 <- data.frame(
id_cliente_enc = lista_3,
producto = productos
)
lista_3
############################### OBJETIVO 1 #####################################
# Creamos el modelo WRMF -------------------------------------------------------
matriz_general <- readRDS("Datos\\Resultados\\Matriz_sinNA.rds")
storage.mode(matriz_general) <- "numeric"
# para el objetivo 1 y 3 cambiamos filas por columnas
matriz_alreves <- t(matriz_general)
# -- MODELO:
modelo_wrmf_alreves <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf_alreves$fit_transform(matriz_alreves, n_iter = 1000L, convergence_tol=0.000001)
matriz_obj1 <- matriz_alreves[rownames(matriz_alreves) %in% objetivos$objetivo1$obj, , drop=F]
matriz_obj1 <- as(matriz_obj1,"sparseMatrix")
preds_1 <- modelo_wrmf_alreves$predict(matriz_obj1, k = 10) # para que nos de 10 usuarios
preds_1
lista_1 <- attr(preds_1,'ids')
################################## OBJETIVO 2 ##################################
# modelo para el objetivo 2 y 4:
modelo_wrmf <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
library(recommenderlab)
library(dplyr)
library(tidyr)
library(rsparse)
library(ggplot2)
library(Matrix)
library(stringr)
################################## OBJETIVO 2 ##################################
# modelo para el objetivo 2 y 4:
modelo_wrmf <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf$fit_transform(matriz_general, n_iter = 1000L, convergence_tol=0.000001)
matriz_obj2 <- matriz_general[rownames(matriz_general) %in% objetivos$objetivo2$obj,]
matriz_obj2 <- as(matriz_obj2,"sparseMatrix")
preds_2 <- modelo_wrmf$predict(matriz_obj2, k = 1, not_recommend = matriz_obj2)
preds_2
lista_2 <- attr(preds_2,'ids')
################################# OBJETIVO 3 ###################################
# el modelo es el mismo que para el objetivo 1
matriz_obj3 <- matriz_general
matriz_obj3 <- as(matriz_obj3,"sparseMatrix")
# cogemos los items que no queremos que recomiente para el predict
matriz_no_recomendados <- matriz_general [,!colnames(matriz_general) %in% objetivos$objetivo3$obj]
items_no_recomendados <- colnames(matriz_no_recomendados)
preds_3 <- modelo_wrmf$predict(matriz_obj3, k = 1, items_exclude = items_no_recomendados)
preds_3
lista_3 <- attr(preds_3,'ids')
################################# OBJETIVO 4 ###################################
obj4<-objetivos[[4]]$obj
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_filtrados, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0,
names_prefix = "id_"
)
matriz_sparse_o4 <- as(as.matrix(df_matriz[,-1]), "dgCMatrix")
rownames(matriz_sparse_o4) <- df_matriz$id_cliente_enc
preds_o4 <- modelo_wrmf$predict(matriz_sparse_o4, k = 1)
################################# OBJETIVO 4 ###################################
obj4<-objetivos[[4]]$obj
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
library(recommenderlab)
library(dplyr)
library(tidyr)
library(rsparse)
library(ggplot2)
library(Matrix)
library(stringr)
################################# OBJETIVO 4 ###################################
obj4<-objetivos[[4]]$obj
tickets_filtrados <- tickets[tickets$id_cliente_enc %in% obj4, ]
ultimos_tickets <- tickets_filtrados %>%
group_by(id_cliente_enc) %>%
filter(dia == max(dia)) %>%
ungroup()
historial_tickets <- anti_join(tickets_filtrados, ultimos_tickets, by = "num_ticket")
tickets_matriz_agrupado <- historial_tickets %>%
group_by(id_cliente_enc, cod_est) %>%
summarise(N_compras = n(), .groups = "drop")
df_matriz <- pivot_wider(
tickets_matriz_agrupado,
names_from = "cod_est",
values_from = "N_compras",
values_fill = 0,
names_prefix = "id_"
)
matriz_obj4 <- as(as.matrix(df_matriz[,-1]), "sparseMatrix")
rownames(matriz_obj4) <- df_matriz$id_cliente_enc
preds_o4 <- modelo_wrmf$predict(matriz_obj4, k = 1)
matriz_obj4
modelo_wrmf
################################## OBJETIVO 2 ##################################
# modelo para el objetivo 2 y 4:
modelo_wrmf <- WRMF$new(rank = 10L, lambda = 0.1, feedback = 'implicit')
modelo_wrmf$fit_transform(matriz_general, n_iter = 1000L, convergence_tol=0.000001)
matriz_obj4 <- as(as.matrix(df_matriz[,-1]), "sparseMatrix")
rownames(matriz_obj4) <- df_matriz$id_cliente_enc
preds_o4 <- modelo_wrmf$predict(matriz_obj4, k = 1)
colnames(matriz_obj4)<- as.character(colnames(matriz_obj4))
preds_o4 <- modelo_wrmf$predict(matriz_obj4, k = 1)
